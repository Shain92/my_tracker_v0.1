<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Блок-схема моделей My Tracker</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network@latest/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            overflow: hidden;
        }

        #network {
            width: 100vw;
            height: 100vh;
            background: #ffffff;
        }

        .details-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(26, 26, 46, 0.95);
            color: #4fc3f7;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #4fc3f7;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 5px 30px rgba(79, 195, 247, 0.5);
            display: none;
            backdrop-filter: blur(10px);
        }

        .details-panel.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .details-panel h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 10px;
        }

        .details-panel .description {
            color: #81d4fa;
            margin-bottom: 15px;
            font-style: italic;
            font-size: 14px;
        }

        .details-panel .field {
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(79, 195, 247, 0.1);
            border-radius: 6px;
            border-left: 3px solid #4fc3f7;
        }

        .details-panel .field-name {
            color: #4fc3f7;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .details-panel .field-type {
            color: #81d4fa;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .details-panel .field-desc {
            color: #b0bec5;
            font-size: 12px;
        }

        .details-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: #4fc3f7;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .details-panel .close-btn:hover {
            background: rgba(79, 195, 247, 0.2);
        }

        .expand-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #4fc3f7;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="details-panel" id="detailsPanel">
        <button class="close-btn" onclick="closeDetails()">×</button>
        <div id="detailsContent"></div>
    </div>
    <div id="network"></div>

    <script>
        // Данные о моделях
        const modelsData = {
            'Department': {
                description: 'Отдел',
                file: 'backend/apps/auth/models.py (7-18)',
                fields: [
                    { name: 'id', type: 'AutoField', desc: 'Первичный ключ', isRelation: false },
                    { name: 'name', type: 'CharField', desc: 'Название', isRelation: false },
                    { name: 'description', type: 'TextField', desc: 'Описание', isRelation: false },
                    { name: 'color', type: 'CharField', desc: 'Цвет (HEX)', isRelation: false }
                ],
                relations: []
            },
            'UserProfile': {
                description: 'Профиль пользователя',
                file: 'backend/apps/auth/models.py (21-43)',
                fields: [
                    { name: 'id', type: 'AutoField', desc: 'Первичный ключ', isRelation: false },
                    { name: 'user', type: 'OneToOneField(User)', desc: 'Пользователь', isRelation: true },
                    { name: 'department', type: 'ForeignKey(Department)', desc: 'Отдел', isRelation: true }
                ],
                relations: [
                    { field: 'user', target: 'User', type: 'OneToOne' },
                    { field: 'department', target: 'Department', type: 'ForeignKey' }
                ]
            },
            'PagePermission': {
                description: 'Право доступа к странице для отдела',
                file: 'backend/apps/auth/models.py (60-92)',
                fields: [
                    { name: 'id', type: 'AutoField', desc: 'Первичный ключ', isRelation: false },
                    { name: 'page_name', type: 'CharField', desc: 'Страница', isRelation: false },
                    { name: 'has_access', type: 'BooleanField', desc: 'Есть доступ', isRelation: false },
                    { name: 'department', type: 'ForeignKey(Department)', desc: 'Отдел', isRelation: true }
                ],
                relations: [
                    { field: 'department', target: 'Department', type: 'ForeignKey' }
                ]
            },
            'Status': {
                description: 'Модель статусов для проектных листов и этапов проекта',
                file: 'backend/apps/projects/models.py (7-25)',
                fields: [
                    { name: 'id', type: 'AutoField', desc: 'Первичный ключ', isRelation: false },
                    { name: 'name', type: 'CharField', desc: 'Название', isRelation: false },
                    { name: 'color', type: 'CharField', desc: 'Цвет (HEX)', isRelation: false },
                    { name: 'status_type', type: 'CharField', desc: 'Тип (sheet/stage)', isRelation: false },
                    { name: 'created_at', type: 'DateTimeField', desc: 'Создан', isRelation: false }
                ],
                relations: []
            },
            'ConstructionSite': {
                description: 'Строительный участок',
                file: 'backend/apps/projects/models.py (28-57)',
                fields: [
                    { name: 'id', type: 'AutoField', desc: 'Первичный ключ', isRelation: false },
                    { name: 'name', type: 'CharField', desc: 'Название', isRelation: false },
                    { name: 'description', type: 'TextField', desc: 'Описание', isRelation: false },
                    { name: 'manager', type: 'ForeignKey(User)', desc: 'Начальник участка', isRelation: true },
                    { name: 'created_at', type: 'DateTimeField', desc: 'Создан', isRelation: false },
                    { name: 'updated_at', type: 'DateTimeField', desc: 'Обновлен', isRelation: false }
                ],
                relations: [
                    { field: 'manager', target: 'User', type: 'ForeignKey' }
                ]
            },
            'Project': {
                description: 'Проект',
                file: 'backend/apps/projects/models.py (60-90)',
                fields: [
                    { name: 'id', type: 'AutoField', desc: 'Первичный ключ', isRelation: false },
                    { name: 'name', type: 'CharField', desc: 'Название', isRelation: false },
                    { name: 'description', type: 'TextField', desc: 'Описание', isRelation: false },
                    { name: 'code', type: 'CharField', desc: 'Код', isRelation: false },
                    { name: 'cipher', type: 'CharField', desc: 'Шифр', isRelation: false },
                    { name: 'construction_site', type: 'ForeignKey(ConstructionSite)', desc: 'Строительный участок', isRelation: true },
                    { name: 'created_at', type: 'DateTimeField', desc: 'Создан', isRelation: false },
                    { name: 'updated_at', type: 'DateTimeField', desc: 'Обновлен', isRelation: false }
                ],
                relations: [
                    { field: 'construction_site', target: 'ConstructionSite', type: 'ForeignKey' }
                ]
            },
            'ProjectSheet': {
                description: 'Проектный лист',
                file: 'backend/apps/projects/models.py (93-154)',
                fields: [
                    { name: 'id', type: 'AutoField', desc: 'Первичный ключ', isRelation: false },
                    { name: 'name', type: 'CharField', desc: 'Название', isRelation: false },
                    { name: 'description', type: 'TextField', desc: 'Описание', isRelation: false },
                    { name: 'project', type: 'ForeignKey(Project)', desc: 'Проект', isRelation: true },
                    { name: 'status', type: 'ForeignKey(Status)', desc: 'Статус', isRelation: true },
                    { name: 'is_completed', type: 'BooleanField', desc: 'Выполнено', isRelation: false },
                    { name: 'completed_at', type: 'DateTimeField', desc: 'Дата выполнения', isRelation: false },
                    { name: 'file', type: 'FileField', desc: 'Файл', isRelation: false },
                    { name: 'executors', type: 'ManyToManyField(User)', desc: 'Исполнители', isRelation: true },
                    { name: 'responsible_department', type: 'ForeignKey(Department)', desc: 'Ответственный отдел', isRelation: true },
                    { name: 'created_by', type: 'ForeignKey(User)', desc: 'Инициатор', isRelation: true },
                    { name: 'created_at', type: 'DateTimeField', desc: 'Создан', isRelation: false },
                    { name: 'updated_at', type: 'DateTimeField', desc: 'Обновлен', isRelation: false }
                ],
                relations: [
                    { field: 'project', target: 'Project', type: 'ForeignKey' },
                    { field: 'status', target: 'Status', type: 'ForeignKey' },
                    { field: 'executors', target: 'User', type: 'ManyToMany' },
                    { field: 'responsible_department', target: 'Department', type: 'ForeignKey' },
                    { field: 'created_by', target: 'User', type: 'ForeignKey' }
                ]
            },
            'ProjectStage': {
                description: 'Этап проекта',
                file: 'backend/apps/projects/models.py (157-198)',
                fields: [
                    { name: 'id', type: 'AutoField', desc: 'Первичный ключ', isRelation: false },
                    { name: 'project', type: 'ForeignKey(Project)', desc: 'Проект', isRelation: true },
                    { name: 'status', type: 'ForeignKey(Status)', desc: 'Статус этапа', isRelation: true },
                    { name: 'datetime', type: 'DateTimeField', desc: 'Дата-время', isRelation: false },
                    { name: 'author', type: 'ForeignKey(User)', desc: 'Автор', isRelation: true },
                    { name: 'responsible_users', type: 'ManyToManyField(User)', desc: 'Ответственные лица', isRelation: true },
                    { name: 'description', type: 'TextField', desc: 'Описание', isRelation: false },
                    { name: 'file', type: 'FileField', desc: 'Файл', isRelation: false },
                    { name: 'created_at', type: 'DateTimeField', desc: 'Создан', isRelation: false }
                ],
                relations: [
                    { field: 'project', target: 'Project', type: 'ForeignKey' },
                    { field: 'status', target: 'Status', type: 'ForeignKey' },
                    { field: 'author', target: 'User', type: 'ForeignKey' },
                    { field: 'responsible_users', target: 'User', type: 'ManyToMany' }
                ]
            },
            'ProjectSheetNote': {
                description: 'Заметка проектного листа',
                file: 'backend/apps/projects/models.py (201-228)',
                fields: [
                    { name: 'id', type: 'AutoField', desc: 'Первичный ключ', isRelation: false },
                    { name: 'name', type: 'CharField', desc: 'Название', isRelation: false },
                    { name: 'note', type: 'TextField', desc: 'Заметка', isRelation: false },
                    { name: 'file', type: 'FileField', desc: 'Файл', isRelation: false },
                    { name: 'author', type: 'ForeignKey(User)', desc: 'Автор', isRelation: true },
                    { name: 'project_sheet', type: 'ForeignKey(ProjectSheet)', desc: 'Проектный лист', isRelation: true },
                    { name: 'created_at', type: 'DateTimeField', desc: 'Создан', isRelation: false },
                    { name: 'updated_at', type: 'DateTimeField', desc: 'Обновлен', isRelation: false }
                ],
                relations: [
                    { field: 'author', target: 'User', type: 'ForeignKey' },
                    { field: 'project_sheet', target: 'ProjectSheet', type: 'ForeignKey' }
                ]
            },
            'User': {
                description: 'Пользователь (Django)',
                file: 'Django стандартная модель',
                fields: [
                    { name: 'id', type: 'AutoField', desc: 'Первичный ключ', isRelation: false },
                    { name: 'username', type: 'CharField', desc: 'Имя пользователя', isRelation: false },
                    { name: 'email', type: 'EmailField', desc: 'Email', isRelation: false }
                ],
                relations: []
            }
        };

        // Функция для получения названия модели с полями-связями
        function getModelLabel(modelName) {
            const model = modelsData[modelName];
            if (!model) return modelName;
            
            let label = modelName;
            if (model.relations.length > 0) {
                label += '\n─────────────';
                model.relations.forEach(rel => {
                    label += `\n• ${rel.field} → ${rel.target}`;
                });
            }
            return label;
        }

        // Функция для отображения всех полей
        function showDetails(modelName) {
            const model = modelsData[modelName];
            if (!model) return;

            const panel = document.getElementById('detailsPanel');
            const content = document.getElementById('detailsContent');
            
            let html = `<h3>${modelName}</h3>`;
            html += `<div class="description">${model.description}</div>`;
            html += `<div style="margin-bottom: 10px; font-size: 12px; color: #81d4fa;">Файл: ${model.file}</div>`;
            html += '<div style="margin-top: 15px;"><strong>Все поля:</strong></div>';
            
            model.fields.forEach(field => {
                html += `
                    <div class="field">
                        <div class="field-name">${field.name}</div>
                        <div class="field-type">${field.type}</div>
                        <div class="field-desc">${field.desc}</div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
            panel.classList.add('show');
        }

        function closeDetails() {
            document.getElementById('detailsPanel').classList.remove('show');
        }

        // Создание узлов
        const nodes = new vis.DataSet([
            { id: 1, label: getModelLabel('User'), shape: 'box', color: { background: '#81d4fa', border: '#4fc3f7' }, model: 'User' },
            { id: 2, label: getModelLabel('Department'), shape: 'box', color: { background: '#66bb6a', border: '#4caf50' }, model: 'Department' },
            { id: 3, label: getModelLabel('UserProfile'), shape: 'box', color: { background: '#66bb6a', border: '#4caf50' }, model: 'UserProfile' },
            { id: 4, label: getModelLabel('PagePermission'), shape: 'box', color: { background: '#66bb6a', border: '#4caf50' }, model: 'PagePermission' },
            { id: 5, label: getModelLabel('Status'), shape: 'box', color: { background: '#66bb6a', border: '#4caf50' }, model: 'Status' },
            { id: 6, label: getModelLabel('ConstructionSite'), shape: 'box', color: { background: '#66bb6a', border: '#4caf50' }, model: 'ConstructionSite' },
            { id: 7, label: getModelLabel('Project'), shape: 'box', color: { background: '#66bb6a', border: '#4caf50' }, model: 'Project' },
            { id: 8, label: getModelLabel('ProjectSheet'), shape: 'box', color: { background: '#66bb6a', border: '#4caf50' }, model: 'ProjectSheet' },
            { id: 9, label: getModelLabel('ProjectStage'), shape: 'box', color: { background: '#66bb6a', border: '#4caf50' }, model: 'ProjectStage' },
            { id: 10, label: getModelLabel('ProjectSheetNote'), shape: 'box', color: { background: '#66bb6a', border: '#4caf50' }, model: 'ProjectSheetNote' }
        ]);

        // Создание рёбер (связи между моделями)
        const edges = new vis.DataSet([
            // UserProfile связи
            { from: 3, to: 1, arrows: 'to', label: 'user', color: { color: '#4fc3f7' } },
            { from: 3, to: 2, arrows: 'to', label: 'department', color: { color: '#4fc3f7' } },
            // PagePermission связи
            { from: 4, to: 2, arrows: 'to', label: 'department', color: { color: '#4fc3f7' } },
            // ConstructionSite связи
            { from: 6, to: 1, arrows: 'to', label: 'manager', color: { color: '#4fc3f7' } },
            // Project связи
            { from: 7, to: 6, arrows: 'to', label: 'construction_site', color: { color: '#4fc3f7' } },
            // ProjectSheet связи
            { from: 8, to: 7, arrows: 'to', label: 'project', color: { color: '#4fc3f7' } },
            { from: 8, to: 5, arrows: 'to', label: 'status', color: { color: '#4fc3f7' } },
            { from: 8, to: 1, arrows: 'to', label: 'executors', color: { color: '#ff9800' }, dashes: true },
            { from: 8, to: 1, arrows: 'to', label: 'created_by', color: { color: '#4fc3f7' } },
            { from: 8, to: 2, arrows: 'to', label: 'responsible_department', color: { color: '#4fc3f7' } },
            // ProjectStage связи
            { from: 9, to: 7, arrows: 'to', label: 'project', color: { color: '#4fc3f7' } },
            { from: 9, to: 5, arrows: 'to', label: 'status', color: { color: '#4fc3f7' } },
            { from: 9, to: 1, arrows: 'to', label: 'author', color: { color: '#4fc3f7' } },
            { from: 9, to: 1, arrows: 'to', label: 'responsible_users', color: { color: '#ff9800' }, dashes: true },
            // ProjectSheetNote связи
            { from: 10, to: 8, arrows: 'to', label: 'project_sheet', color: { color: '#4fc3f7' } },
            { from: 10, to: 1, arrows: 'to', label: 'author', color: { color: '#4fc3f7' } }
        ]);

        // Данные для визуализации
        const data = {
            nodes: nodes,
            edges: edges
        };

        // Настройки
        const options = {
            nodes: {
                shape: 'box',
                font: {
                    size: 12,
                    face: 'Segoe UI',
                    bold: true,
                    align: 'left'
                },
                borderWidth: 2,
                shadow: true,
                margin: 10,
                widthConstraint: {
                    minimum: 200,
                    maximum: 280
                }
            },
            edges: {
                arrows: {
                    to: {
                        enabled: true,
                        scaleFactor: 1.2
                    }
                },
                font: {
                    size: 11,
                    align: 'middle',
                    background: 'white',
                    strokeWidth: 2,
                    strokeColor: 'white'
                },
                color: {
                    color: '#4fc3f7',
                    highlight: '#29b6f6'
                },
                smooth: {
                    type: 'continuous',
                    roundness: 0.5
                }
            },
            layout: {
                hierarchical: {
                    enabled: true,
                    direction: 'UD',
                    sortMethod: 'directed',
                    levelSeparation: 240,
                    nodeSpacing: 300,
                    treeSpacing: 450,
                    blockShifting: true,
                    edgeMinimization: true,
                    parentCentralization: true
                }
            },
            physics: {
                enabled: false
            },
            interaction: {
                zoomView: true,
                dragView: true,
                dragNodes: true,
                selectConnectedEdges: false
            }
        };

        // Создание сети
        const container = document.getElementById('network');
        const network = new vis.Network(container, data, options);

        // Обработка двойного клика на узел для показа деталей
        network.on('doubleClick', function(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = nodes.get(nodeId);
                if (node.model) {
                    showDetails(node.model);
                }
            }
        });

        // Обработка клика на стрелку (ребро)
        network.on('click', function(params) {
            if (params.edges.length > 0) {
                const edgeId = params.edges[0];
                const edge = edges.get(edgeId);
                const node = nodes.get(edge.to);
                if (node.model) {
                    showDetails(node.model);
                }
            }
        });

        // Подсветка при наведении
        network.on('hoverNode', function(params) {
            container.style.cursor = 'pointer';
        });

        network.on('blurNode', function() {
            container.style.cursor = 'default';
        });

        // Автоматическое масштабирование при загрузке и отключение иерархического layout
        network.on('stabilizationEnd', function() {
            network.fit({
                animation: {
                    duration: 500,
                    easingFunction: 'easeInOutQuad'
                }
            });
            
            // Отключаем иерархический layout после загрузки для свободного перемещения
            setTimeout(() => {
                const newOptions = {
                    layout: {
                        hierarchical: {
                            enabled: false
                        }
                    }
                };
                network.setOptions(newOptions);
            }, 600);
        });

        // Сохраняем позиции узлов при перетаскивании
        network.on('dragEnd', function(params) {
            if (params.nodes.length > 0) {
                // Позиции уже сохранены автоматически в vis.js
            }
        });

        // Закрытие панели при клике вне её
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('detailsPanel');
            if (panel.classList.contains('show') && !panel.contains(event.target)) {
                // Проверяем, что клик не на узле сети
                if (!event.target.closest('#network')) {
                    closeDetails();
                }
            }
        });
    </script>
</body>
</html>